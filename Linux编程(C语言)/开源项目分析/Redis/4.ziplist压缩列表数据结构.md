# ziplist压缩列表数据结构

### 源码所在文件：

​	`ziplist.h、ziplist.c`

### 数据结构详解：

	> ziplist并不是又结构体构成的单向链表，而是整体是一个字符串，只是根据特定的解析方法解析字符串得到节点。字符串结构如下：

![](https://github.com/NiceNelg/Note/blob/master/Linux%E7%BC%96%E7%A8%8B(C%E8%AF%AD%E8%A8%80)/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE%E5%88%86%E6%9E%90/Redis/images/3.png?raw=true)

![](https://github.com/NiceNelg/Note/blob/master/Linux%E7%BC%96%E7%A8%8B(C%E8%AF%AD%E8%A8%80)/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE%E5%88%86%E6%9E%90/Redis/images/4.png?raw=true)

### 各数据字段说明：

1. zlbytes是一个4字节无符号整型，存储的是整个ziplist占用的字节数。它主要用于重新分配内存时使用，这样就不必遍历整个列表以确定其长度。
2. zltail是一个4字节无符号整型，存储的是链表最后一个节点的偏移值，即链表开头地址 + zltail的值为最后一个节点的起始地址。
3. zllen是一个2字节无符号整型，存储的是链表中的节点总数。当这个值超过2^16-2时就需要遍历整个链表来获取链表的节点总数。
4. entry是ziplist所保存的节点。
5. zlend是一个链表尾部的占位符，表示链表结束。它占用1个字节，值为255。

### entry：

1. 第一部分存储的是上一个链表节点的长度prev_entry_length，利用这个值就可以通过指针运算直接跳转到前一个节点。prev_entry_length域，也就是上一个链表节点的长度占用的字节数根据编码类型而定，可能是1个字节或者5个字节：
   - 1字节：当前一个链表节点的长度值小于254时使用1个字节存储，该字节存储的数值就是上一个节点的长度值。
   - 5字节：当前一个链表节点的长度值大于或等于254时使用5个字节存储，第1个字节的数值为254，表示上一个节点的长度值大于等于254接下来的4个字节才是真正的长度。
2. 第二部分存储的是编码类型encoding和当前节点的长度cur_entry_length。其中encoding域占用2个bit，这样encoding就有四种不同的取值，分别是00、01、10、11。redis规定如下：
   - 如果encoding域的取值为11，表示整型编码，该节点数据域存储的是一个整型值。
   - 如果encoding域的取值为00、01和10，表示字符串编码，该节点数据域存储的是一个字符串。
   - 对于encoding&cur_entry_length域的数据存储，规则如下：
     - 字符串：

| 数据                                                | 数据长度 | 含义                                                         |
| --------------------------------------------------- | -------- | ------------------------------------------------------------ |
| 00xx,xxxx                                           | 1字节    | 表示长度小于等于63字节的字符串，后6位用于存储字符串长度。    |
| 01xx,xxxx,xxxx                                      | 2字节    | 表示长度小于等于16383字节的字符串，后14用于存储字符串长度    |
| 10____,____,xxxx,xxxx,xxxx,xxxx,xxxx,xxxx,xxxx,xxxx | 5字节    | 表示长度大于等于16384字节的字符串，前1个字节的后6位无意义，后4个字节用来存储字符串长度 |

	- 整型数据：

| 数据     | 数据长度 | 含义                               |
| -------- | -------- | ---------------------------------- |
| 11000000 | 1字节    | int16_t整型                        |
| 11010000 | 1字节    | int32_t整型                        |
| 11100000 | 1字节    | int64_t整型                        |
| 11110000 | 1字节    | 24bit有符号整数                    |
| 11111110 | 1字节    | 8bit有符号整型                     |
| 1111xxxx | 1字节    | 4bit无符号整型，表示[0,12]范围的数 |

> 注：上述表格中x代码0或1,_代表无意义

​	