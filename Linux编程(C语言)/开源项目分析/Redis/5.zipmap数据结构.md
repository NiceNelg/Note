# zipmap数据结构

### 源码所在文件：

​	`zipmap.h、zipmap.c`

### 数据结构详解：

- 此数据结构主要是用来存储键值对，但使用的是一整个字符串存储，通过特定规则解析字符串得出对应的键值对，字符串结构如下：

![](https://github.com/NiceNelg/Note/blob/master/Linux%E7%BC%96%E7%A8%8B(C%E8%AF%AD%E8%A8%80)/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE%E5%88%86%E6%9E%90/Redis/images/5.png?raw=true)

- 各部分的含义如下：

  1. zmlen字段

     > zmlen是1个字节的无符号整型数，表示zipmap当前的键值对数量，最多只能表示253个键值对。当zipmap中的元素数量大于或等于254时，只能通过遍历一遍zipmap来确定其大小。

  2. key length和value length字段

     > 这两个length字段的编码方式和ziplist有些类似，可以用1个字节或5个字节编码表示，具体如下：
     >
     > 如果随后的字符串（key或value）长度小于或等于253，直接用1个字节表示其长度。
     >
     > 如果随后的字符串（key或value）长度超过254，则用5个字节表示，其中第一个字节值为254，接下来的4个字节才是字符串长度。

  3. free字段

     > free表示随后的value后面的空闲字节数。比如：假设zipmap存在”foo” => “bar”这样一个键值对，随后我们将“bar”设置为“hi”，此时free = 1，表示value字符串后面有1个字节大小的空闲空间。
     >
     > free字段是一个占1个字节的整型数，它的值一般都比较小，如果空闲区间太大，zipmap会进行调整以使整个map尽可能小，这个过程发生在zipmapSet操作中。

  4. end字段

     > end是zipmap的结尾符，占用1个字节，其值为255。
     >
     > 从zipmap的存储结构中我们可以看到，zipmap中的键值对就是顺序存放的key和value字符串，中间加入了相关的字符串长度编码信息以方便我们获取相关的key和value。而整个zipmap就是在一块内存区中依次存放key-value字符串。