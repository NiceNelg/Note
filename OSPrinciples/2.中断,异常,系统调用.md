# 中断、异常与系统调用

---

### 中断

- 中断流程

  1. 硬件（外设、CPU）

     > 中断的产生首先由硬件开始，硬件负责设置中断标记，然后CPU检测到标记后会找到对应的中断号，最后CPU将中断号发送给操作系统进行后续操作。

     1. 将内部、外部事件设置中断标记
     2. 中断事件的ID

  2. 软件（操作系统）

     > 操作系统接收到中断号时首先先保存当前处理状态（寄存器状态等等），保存后操作系统根据中断号找到中断号对应的中断处理程序的地址并跳转执行，执行完后清除中断标记并恢复之前保存的处理状态。

     1. 保存当前处理状态
     2. 中断服务程序处理
     3. 清除中断标记
     4. 恢复之前保存的处理状态

### 异常

- 异常处理流程

  1. 保存现场

     > 当某个程序执行某条特定的指令之后，这条指令触发异常事件，CPU会得到一个异常编号，操作系统会首先保存现场。

  2. 异常处理

     > 当操作系统得到了异常编号后会根据异常编号从以下两种处理方式挑选一种方式进行执行。

     - 杀死产生异常的程序

       > 当操作系统判断这个异常编号是无法容忍或弥补时会进行杀死进程的操作。

     - 重新执行异常指令

       > 当操作系统判断这个异常是操作系统本身没有服务到位时，会进行一些弥补操作，如分配更多的内存空间等等，然后将保存的寄存器和保存的地址恢复之后，重新执行该指令。

  3. 恢复现场

### 系统调用

> 应用程序需要操作系统提供服务，该服务不能由应用程序直接执行，需要由操作系统提供。操作系统会提供各种各样的接口，即系统API供应用程序调用，如：数据打印到屏幕上。

- 系统API类型

  - `Win32 API`主要用于Windows
  - `POSIX API`主要用于`POSIX-based systems`（包括Unix，Linux，Mac OS X的所有版本）
  - `Java API`用于JAVA虚拟机（JVM）

- 系统调用流程

  > APP->Library Code->System Call Interface->Kernel->Devices
  >
  > (用户态)                                                           (内核态)

### 用户态和内核态

1. 用户态和内核态表示的是CPU在执行的过程中处于的不同特权级的状态；

2. 用户态指的是在CPU运行的时候执行的是应用程序的计算，此时CPU不能执行某些特定的机器指令和IO；

3. 内核态指的是在CPU运行的时候执行的是操作系统的计算，此时CPU可以执行任何一条指定；

4. 当用户态和内核态相互切换的时候都需要切换堆栈空间以及特权级的转换，会消耗一定的资源和时间；

   > 为了建立用户态和内核态以及相互切换的时候的开销
   1. 在系统启动伊始就需要建立中断/异常/系统调用与对应服务例程映射关系的映射表；
   2. 建立内核（操作系统）堆栈和维护内核堆栈的开销；
   3. 在退出用户态（内核态）和进入内核态（用户态）时候的保存和恢复；
   4. 在用户态发出系统调用的时候需要对该调用的参数进行验证，因为操作系统不信任应用程序；
   5. 在内核中产生的数据如果需要回传到应用程序则需要数据拷贝，无法直接使用指针传值的方式进行传递；

   ......