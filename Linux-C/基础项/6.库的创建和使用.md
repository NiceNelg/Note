# 库的创建和使用

---

### 静态库

- 创建静态库

  1. 将`.c`文件打包成`.o`文件：

     `gcc x.c -c`

  2. 将`.o`文件打包：

  3. `ar rcs libxx.a x.o`

     > 打包规则：`lib`前缀为必须填，`.a`结尾为必须。

- 使用静态库

  1. 添加打包参数`-I`指定头文件目录，`-L`指定静态库目录，添加`-l`参数指定静态库名称，如：

     `gcc test.c -I ../include/ -L ../lib/ -l xx -o test`

### 动态库

- 创建动态库

  1. 将`.c`文件打包成`.o`文件：

     - `gcc x.c -c -fpic -I 头文件目录`
     - `gcc x.c -c -fPIC -I 头文件目录`

     > 以上两个命令均可

  2. 将`.o`文件打包：

     `gcc --shared x.o y.o -o libxx.so`

     > 打包规则：`lib`前缀为必须填，`.so`结尾为必须，动态库的`.so`后面可以接`.xx.xx`，指的是版本，非必须

- 使用动态库

  1. 添加打包参数`-I`指定头文件目录，参数`-L`指定动态库目录，添加`-l`参数指定动态库名称，如：

     `gcc test.c -I ../include/ -L ../lib/ -l xx -o test`

  2. 当执行程序的时候会提示找不到动态库，解决方法如下：

     > 找不到动态库的原因是ELF格式的程序（Linux下的所有可执行程序均为ELF格式，可使用`file <文件名>`查看文件格式）中的需要调用的动态库代码都是通过系统的动态库载入器（`ld-linux-x86-64.so.2`)预先将动态库的代码加载到内存中，而载入器以以下顺序搜索动态库并加载：
     >
     > 1. ELF程序的`DT_RPPATH`段
     > 2. 环境变量`LD_LIBRARY_PATH`记录的动态库路径
     > 3. `/etc/ld.so.cache`配置文件记录的动态库路径
     > 4. `/lib/`目录下的动态库
     > 5. `/usr/lib/`目录下的动态库
     >
     > 可使用`ldd <程序路径>`查看程序需要用到的动态库、动态库是否已加载、动态库所在的内存地址

     - 修改环境变量`LD_LIBRARY_PATH`添加动态库路径

     - 修改`/etc/ld.so.cache`配置文件添加动态库路径

     - 将动态库移动到`/lib/`目录下

     - 将动态库移动到`/usr/lib/`目录下

     - 在代码中使用`dlopen`、`dlclose`、`dlsym`函数指明加载动态库，该方式少用但能增加加载效率以及程序结束后手动清除动态库加载在内存的空间