# Kubernetes基础

---

### Kubernetes软件架构图

![](./images/1.png)

### Kubernetes安装（CentOS）

> Kubernetes安装方式较为繁琐，因此官方提供了一个集安装、初始化集群、添加节点等功能的脚本工具`kubeadm`，我们可通过这个软件对Kubernetes进行初始化。

1. 修改YUM源，使用阿里云镜像

2. `yum install docker-ce kubelet kubeadm kubectl`

3. 修改`/usr/lib/systemd/system/docker.service`,在`[Service]`中添加一个环境变量用于下载Kubernetes需要但目前国内无法下载的`docker`镜像。

   ```shell
   [Service]
   Type=notify
   # the default is not to use systemd for cgroups because the delegate issues still
   # exists and systemd currently does not support the cgroup feature set required
   # for containers run by docker
   # 添加不可描述的环境变量
   Environment="HTTPS_PROXY=http://www.ik8s.io:10080"
   Environment="NO_PROXY=127.0.0.0/8,172.20.0.0/16"
   ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock
   ExecReload=/bin/kill -s HUP $MAINPID
   TimeoutSec=0
   RestartSec=2
   Restart=always
   ```

4. 确认`iptables`规则可写

   1. `cat /proc/sys/net/bridge/bridge-nf-call-iptables`
   2. `cat /proc/sys/net/bridge/bridge-nf-call-ip6tables`

   > 确认上述两个文件的值都是1。
   >
   > 若都不是1，解决方案是
   >
   > 1. `vim /etc/rc.d/rc.local`添加以下语句
   >
   >    ```shell
   >    echo 1 > /proc/sys/net/bridge/bridge-nf-call-iptables
   >    echo 1 > /proc/sys/net/bridge/bridge-nf-call-ip6tables
   >    ```
   >
   >    增加执行权限：`chmod +x　/etc/rc,d/rc.local`
   >
   > 2. `vim /etc/sysctl.conf`添加以下语句
   >
   >    ```shell
   >    net.bridge.bridge-nf-call-ip6tables = 1
   >    net.bridge.bridge-nf-call-iptables = 1
   >    net.bridge.bridge-nf-call-arptables = 1
   >    ```
   >
   >    添加后执行：`sysctl -p`